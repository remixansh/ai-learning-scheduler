<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Learning Scheduler</title>
  <meta name="description"
    content="Generate personalized AI-powered learning schedules with curated video recommendations.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ========================================
       DESIGN TOKENS
       ======================================== */
    :root {
      --accent: #E8684A;
      --accent-light: #FDEEE9;
      --accent-hover: #D45A3E;
      --bg: #FAFBF9;
      --surface: #FFFFFF;
      --text: #1A1A1A;
      --text-secondary: #7A7A7A;
      --text-tertiary: #A0A0A0;
      --border: #EBEBEB;
      --border-hover: #D4D4D4;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 8px 30px rgba(0, 0, 0, 0.08);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --transition: 0.2s ease;
    }

    /* ========================================
       RESET & BASE
       ======================================== */
    *,
    *::before,
    *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body.no-scroll {
      overflow: hidden;
    }

    /* ========================================
       LAYOUT
       ======================================== */
    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 0 24px;
    }

    /* ========================================
       HEADER
       ======================================== */
    .header {
      padding: 48px 0 40px;
      text-align: center;
    }

    .header h1 {
      font-size: 2rem;
      font-weight: 700;
      letter-spacing: -0.03em;
      color: var(--text);
    }

    .header h1 span {
      color: var(--accent);
    }

    .header p {
      margin-top: 8px;
      font-size: 0.95rem;
      color: var(--text-secondary);
      font-weight: 400;
    }

    /* ========================================
       ACTION BAR
       ======================================== */
    .action-bar {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 32px;
    }

    .btn-ghost {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 18px;
      font-size: 13px;
      font-weight: 500;
      font-family: inherit;
      color: var(--text-secondary);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 100px;
      cursor: pointer;
      transition: all var(--transition);
    }

    .btn-ghost:hover {
      color: var(--text);
      border-color: var(--border-hover);
      box-shadow: var(--shadow-sm);
    }

    .btn-ghost svg {
      width: 15px;
      height: 15px;
      stroke-width: 2;
    }

    /* ========================================
       FORM
       ======================================== */
    .input-form {
      background: var(--surface);
      padding: 32px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      margin: 0 auto 48px;
      max-width: 580px;
    }

    .input-group {
      margin-bottom: 20px;
    }

    .input-group label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 6px;
      letter-spacing: 0.01em;
    }

    input[type="text"],
    input[type="number"] {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 15px;
      font-family: inherit;
      color: var(--text);
      background: var(--bg);
      transition: all var(--transition);
    }

    input[type="text"]:focus,
    input[type="number"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-light);
      background: var(--surface);
    }

    input::placeholder {
      color: var(--text-tertiary);
    }

    .duration-input-container {
      display: flex;
      gap: 10px;
    }

    .duration-input-container input[type="number"] {
      flex: 1;
    }

    .duration-input-container select {
      width: 110px;
      flex-shrink: 0;
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 15px;
      font-family: inherit;
      color: var(--text);
      background: var(--bg);
      transition: all var(--transition);
      cursor: pointer;
    }

    .duration-input-container select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-light);
    }

    .btn-primary {
      width: 100%;
      padding: 13px;
      background: var(--accent);
      color: #FFFFFF;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      font-family: inherit;
      letter-spacing: 0.01em;
      transition: all var(--transition);
      margin-top: 4px;
    }

    .btn-primary:hover {
      background: var(--accent-hover);
      box-shadow: 0 4px 14px rgba(232, 104, 74, 0.25);
    }

    .btn-primary:active {
      transform: scale(0.985);
    }

    /* ========================================
       SCHEDULE GRID
       ======================================== */
    #schedule-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
      padding-bottom: 64px;
    }

    .day-card {
      background: var(--surface);
      border-radius: var(--radius-md);
      padding: 24px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all var(--transition);
      position: relative;
      animation: cardFadeIn 0.4s ease forwards;
      opacity: 0;
    }

    .day-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 24px;
      right: 24px;
      height: 3px;
      background: var(--accent);
      border-radius: 0 0 3px 3px;
      opacity: 0.7;
      transition: opacity var(--transition);
    }

    .day-card:hover {
      border-color: var(--border-hover);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .day-card:hover::before {
      opacity: 1;
    }

    .day-card h2 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text);
      margin: 4px 0 12px;
      line-height: 1.4;
    }

    .day-card .day-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .day-card h3 {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin: 16px 0 8px;
    }

    .day-card ul {
      padding-left: 0;
      list-style: none;
      color: var(--text-secondary);
      font-size: 14px;
    }

    .day-card ul li {
      padding: 3px 0;
      padding-left: 18px;
      position: relative;
    }

    .day-card ul li::before {
      content: '';
      position: absolute;
      left: 0;
      top: 11px;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent-light);
      border: 1.5px solid var(--accent);
    }

    .day-card .exercise-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 16px;
      display: block;
    }

    .day-card p {
      margin-top: 4px;
      color: var(--text-secondary);
      font-size: 14px;
      line-height: 1.5;
    }

    @keyframes cardFadeIn {
      from {
        opacity: 0;
        transform: translateY(12px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ========================================
       LOADING OVERLAY
       ======================================== */
    #loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      align-items: center;
      justify-content: center;
      background: rgba(250, 251, 249, 0.92);
      backdrop-filter: blur(6px);
      z-index: 2000;
    }

    .loader-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      gap: 20px;
    }

    .loader-content p {
      margin: 0;
      text-align: center;
      font-size: 15px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    /* Pulsing dots loader */
    .loader {
      display: flex;
      gap: 8px;
    }

    .loader span {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent);
      animation: pulse 1.4s ease-in-out infinite;
    }

    .loader span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .loader span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes pulse {

      0%,
      80%,
      100% {
        opacity: 0.25;
        transform: scale(0.8);
      }

      40% {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* ========================================
       LIGHTBOX MODAL
       ======================================== */
    #lightbox-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(4px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 24px;
      box-sizing: border-box;
    }

    #lightbox-content {
      background: var(--surface);
      padding: 32px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      max-width: 600px;
      width: 100%;
      position: relative;
      max-height: 85vh;
      overflow-y: auto;
      animation: modalIn 0.25s ease;
    }

    #lightbox-content::-webkit-scrollbar {
      width: 6px;
    }

    #lightbox-content::-webkit-scrollbar-track {
      background: transparent;
    }

    #lightbox-content::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    @keyframes modalIn {
      from {
        opacity: 0;
        transform: translateY(16px) scale(0.97);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .close-btn {
      position: absolute;
      top: 16px;
      right: 20px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      color: var(--text-tertiary);
      cursor: pointer;
      line-height: 1;
      transition: all var(--transition);
      border-radius: 50%;
      background: transparent;
    }

    .close-btn:hover {
      color: var(--text);
      background: var(--bg);
    }

    /* Lightbox inner content */
    #lightbox-body h2 {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
      padding-right: 40px;
      line-height: 1.4;
    }

    #lightbox-body .lightbox-day-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 16px;
      display: block;
    }

    #lightbox-body h3 {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 20px;
      margin-bottom: 10px;
      padding-bottom: 0;
      border-bottom: none;
    }

    #lightbox-body ul {
      padding-left: 0;
      list-style: none;
      color: var(--text-secondary);
      font-size: 14px;
    }

    #lightbox-body ul li {
      padding: 4px 0;
      padding-left: 18px;
      position: relative;
    }

    #lightbox-body ul li::before {
      content: '';
      position: absolute;
      left: 0;
      top: 12px;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent-light);
      border: 1.5px solid var(--accent);
    }

    #lightbox-body strong {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 20px;
    }

    #lightbox-body p {
      margin-top: 6px;
      color: var(--text-secondary);
      font-size: 14px;
      line-height: 1.6;
    }

    /* ========================================
       VIDEO SECTION
       ======================================== */
    .video-section {
      margin-top: 24px;
      border-top: 1px solid var(--border);
      padding-top: 20px;
    }

    .video-section h3 {
      font-size: 12px !important;
      color: var(--text-secondary) !important;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 14px !important;
      margin-top: 0 !important;
    }

    .video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 12px;
    }

    .video-card {
      background: var(--bg);
      border-radius: var(--radius-sm);
      overflow: hidden;
      transition: all var(--transition);
      cursor: pointer;
      text-decoration: none;
      color: inherit;
      display: block;
      border: 1px solid var(--border);
    }

    .video-card:hover {
      border-color: var(--border-hover);
      box-shadow: var(--shadow-sm);
      transform: translateY(-1px);
    }

    .video-card img {
      width: 100%;
      height: auto;
      display: block;
      aspect-ratio: 16/9;
      object-fit: cover;
    }

    .video-info {
      padding: 10px;
    }

    .video-title {
      font-size: 12px;
      font-weight: 500;
      line-height: 1.4;
      margin-bottom: 4px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      color: var(--text);
    }

    .channel-title {
      font-size: 11px;
      color: var(--text-tertiary);
    }

    /* ========================================
       SKELETON LOADER
       ======================================== */
    .skeleton-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 12px;
    }

    .skeleton-card {
      background: var(--bg);
      border-radius: var(--radius-sm);
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .skeleton-thumb {
      width: 100%;
      aspect-ratio: 16/9;
      background: linear-gradient(to right, var(--border) 4%, #f5f5f5 25%, var(--border) 36%);
      background-size: 1000px 100%;
      animation: shimmer 1.5s infinite linear;
    }

    .skeleton-info {
      padding: 10px;
    }

    .skeleton-text {
      height: 10px;
      background: linear-gradient(to right, var(--border) 4%, #f5f5f5 25%, var(--border) 36%);
      background-size: 1000px 100%;
      border-radius: 4px;
      margin-bottom: 6px;
      animation: shimmer 1.5s infinite linear;
    }

    .skeleton-text.short {
      width: 60%;
    }

    @keyframes shimmer {
      0% {
        background-position: -1000px 0;
      }

      100% {
        background-position: 1000px 0;
      }
    }

    /* ========================================
       FOOTER
       ======================================== */
    .footer {
      text-align: center;
      padding: 32px 0 40px;
      font-size: 12px;
      color: var(--text-tertiary);
      letter-spacing: 0.02em;
    }

    .footer a {
      color: var(--accent);
      text-decoration: none;
    }

    /* ========================================
       ERROR STATE
       ======================================== */
    .error-message {
      text-align: center;
      padding: 40px 20px;
      color: var(--accent);
      font-size: 15px;
      font-weight: 500;
    }

    /* ========================================
       NAVIGATION TABS
       ======================================== */
    .nav-tabs {
      display: flex;
      justify-content: center;
      gap: 4px;
      margin-bottom: 32px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 100px;
      padding: 4px;
      max-width: 280px;
      margin-left: auto;
      margin-right: auto;
    }

    .nav-tab {
      flex: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 9px 20px;
      font-size: 13px;
      font-weight: 500;
      font-family: inherit;
      color: var(--text-secondary);
      background: transparent;
      border: none;
      border-radius: 100px;
      cursor: pointer;
      transition: all var(--transition);
    }

    .nav-tab:hover {
      color: var(--text);
    }

    .nav-tab.active {
      background: var(--accent);
      color: #FFFFFF;
      box-shadow: 0 2px 8px rgba(232, 104, 74, 0.25);
    }

    .nav-tab svg {
      width: 16px;
      height: 16px;
      stroke-width: 2;
    }

    /* Tab content */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* ========================================
       SAVE ROUTINE BUTTON
       ======================================== */
    .save-routine-bar {
      display: none;
      justify-content: center;
      margin-bottom: 20px;
      animation: cardFadeIn 0.3s ease;
    }

    .save-routine-bar.visible {
      display: flex;
    }

    .btn-save-routine {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 24px;
      font-size: 14px;
      font-weight: 600;
      font-family: inherit;
      color: var(--accent);
      background: var(--accent-light);
      border: 1.5px solid var(--accent);
      border-radius: 100px;
      cursor: pointer;
      transition: all var(--transition);
    }

    .btn-save-routine:hover {
      background: var(--accent);
      color: #FFFFFF;
      box-shadow: 0 4px 14px rgba(232, 104, 74, 0.25);
    }

    .btn-save-routine svg {
      width: 18px;
      height: 18px;
      stroke-width: 2;
    }

    /* ========================================
       PROGRESS TAB
       ======================================== */
    .progress-view {
      max-width: 700px;
      margin: 0 auto;
      padding-bottom: 100px;
    }

    .empty-state {
      text-align: center;
      padding: 80px 20px;
    }

    .empty-state svg {
      width: 56px;
      height: 56px;
      color: var(--border);
      margin-bottom: 16px;
    }

    .empty-state h3 {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 6px;
    }

    .empty-state p {
      font-size: 14px;
      color: var(--text-tertiary);
    }

    /* Routine Card */
    .routine-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      margin-bottom: 12px;
      overflow: hidden;
      transition: all var(--transition);
      animation: cardFadeIn 0.4s ease forwards;
      opacity: 0;
    }

    .routine-header {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      cursor: pointer;
      gap: 14px;
      transition: background var(--transition);
    }

    .routine-header:hover {
      background: var(--bg);
    }

    .routine-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: var(--accent-light);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 18px;
    }

    .routine-info {
      flex: 1;
      min-width: 0;
    }

    .routine-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .routine-meta {
      font-size: 12px;
      color: var(--text-tertiary);
      margin-top: 2px;
    }

    .routine-progress-ring {
      flex-shrink: 0;
      position: relative;
      width: 40px;
      height: 40px;
    }

    .routine-progress-ring svg {
      transform: rotate(-90deg);
    }

    .routine-progress-ring .ring-bg {
      stroke: var(--border);
    }

    .routine-progress-ring .ring-fill {
      stroke: var(--accent);
      transition: stroke-dashoffset 0.4s ease;
    }

    .routine-pct {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 10px;
      font-weight: 700;
      color: var(--text);
    }

    .routine-chevron {
      flex-shrink: 0;
      width: 20px;
      height: 20px;
      color: var(--text-tertiary);
      transition: transform 0.25s ease;
    }

    .routine-card.expanded .routine-chevron {
      transform: rotate(180deg);
    }

    .routine-delete {
      flex-shrink: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: transparent;
      color: var(--text-tertiary);
      border-radius: 6px;
      cursor: pointer;
      transition: all var(--transition);
    }

    .routine-delete:hover {
      background: #FDEEE9;
      color: var(--accent);
    }

    .routine-delete svg {
      width: 16px;
      height: 16px;
      stroke-width: 2;
    }

    /* Routine body (accordion) */
    .routine-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.35s ease;
    }

    .routine-card.expanded .routine-body {
      max-height: 5000px;
    }

    .routine-body-inner {
      padding: 0 20px 20px;
    }

    /* Day section inside routine */
    .progress-day {
      padding: 14px 0;
      border-top: 1px solid var(--border);
    }

    .progress-day-header {
      font-size: 13px;
      font-weight: 600;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 10px;
    }

    .progress-day-topic {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 10px;
    }

    /* Custom Checkbox */
    .check-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 6px 0;
      cursor: pointer;
    }

    .check-item input[type="checkbox"] {
      display: none;
    }

    .check-box {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
      border: 2px solid var(--border);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition);
      margin-top: 1px;
    }

    .check-box svg {
      width: 12px;
      height: 12px;
      opacity: 0;
      transform: scale(0.5);
      transition: all 0.15s ease;
      color: #FFFFFF;
      stroke-width: 3;
    }

    .check-item input:checked+.check-box {
      background: var(--accent);
      border-color: var(--accent);
    }

    .check-item input:checked+.check-box svg {
      opacity: 1;
      transform: scale(1);
    }

    .check-item input:checked~.check-label {
      color: var(--text-tertiary);
      text-decoration: line-through;
    }

    .check-label {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.5;
      transition: all var(--transition);
    }

    .check-label.exercise-check {
      font-style: italic;
    }

    /* ========================================
       MODE TOGGLE (Scheduler / To-Do)
       ======================================== */
    .mode-toggle-desktop {
      position: fixed;
      top: 20px;
      left: 24px;
      z-index: 800;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 9px 20px;
      font-size: 13px;
      font-weight: 600;
      font-family: inherit;
      color: var(--text);
      background: var(--surface);
      border: 1.5px solid var(--border);
      border-radius: 100px;
      cursor: pointer;
      transition: all var(--transition);
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    }

    .mode-toggle-desktop:hover {
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 4px 16px rgba(232, 104, 74, 0.15);
    }

    .mode-toggle-desktop svg {
      width: 16px;
      height: 16px;
      stroke-width: 2;
    }

    .mode-toggle-mobile {
      display: none;
      margin: 0 auto 16px;
      padding: 8px 22px;
      font-size: 13px;
      font-weight: 600;
      font-family: inherit;
      color: var(--text);
      background: var(--surface);
      border: 1.5px solid var(--border);
      border-radius: 100px;
      cursor: pointer;
      transition: all var(--transition);
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
    }

    .mode-toggle-mobile:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .mode-toggle-mobile svg {
      width: 15px;
      height: 15px;
      stroke-width: 2;
    }

    @media (max-width: 640px) {
      .mode-toggle-desktop {
        display: none;
      }

      .mode-toggle-mobile {
        display: inline-flex;
      }
    }

    /* App views transition — vanish effect */
    .app-view {
      transition: opacity 0.45s cubic-bezier(0.4, 0, 0.2, 1),
        transform 0.45s cubic-bezier(0.4, 0, 0.2, 1),
        filter 0.45s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .app-view.vanish {
      opacity: 0;
      transform: scale(0.96) translateY(8px);
      filter: blur(4px);
      pointer-events: none;
    }

    /* ========================================
       TO-DO VIEW
       ======================================== */
    .todo-wrapper {
      display: none;
      max-width: 560px;
      margin: 0 auto;
      padding-bottom: 120px;
    }

    .todo-wrapper.active {
      display: block;
      animation: todoEnter 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    @keyframes todoEnter {
      from {
        opacity: 0;
        transform: scale(0.96) translateY(12px);
        filter: blur(4px);
      }

      to {
        opacity: 1;
        transform: scale(1) translateY(0);
        filter: blur(0);
      }
    }

    .todo-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .todo-header h2 {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text);
    }

    .todo-add-btn-desktop {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 18px;
      font-size: 13px;
      font-weight: 500;
      font-family: inherit;
      color: #FFFFFF;
      background: var(--accent);
      border: none;
      border-radius: 100px;
      cursor: pointer;
      transition: all var(--transition);
    }

    .todo-add-btn-desktop:hover {
      background: var(--accent-hover);
      box-shadow: 0 4px 14px rgba(232, 104, 74, 0.25);
    }

    .todo-add-btn-desktop svg {
      width: 16px;
      height: 16px;
      stroke-width: 2.5;
    }

    @media (max-width: 640px) {
      .todo-add-btn-desktop {
        display: none;
      }
    }

    /* Task item */
    .todo-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 0;
      border-bottom: 1px solid var(--border);
      animation: cardFadeIn 0.3s ease forwards;
      opacity: 0;
      transition: opacity 0.4s ease, transform 0.4s ease;
    }

    .todo-item.sinking {
      opacity: 0.4;
    }

    .todo-item.checked-item {
      opacity: 0.5;
    }

    /* Circular checkbox */
    .todo-check {
      width: 24px;
      height: 24px;
      flex-shrink: 0;
      border: 2px solid var(--border);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      background: transparent;
      padding: 0;
    }

    .todo-check:hover {
      border-color: var(--accent);
    }

    .todo-check svg {
      width: 14px;
      height: 14px;
      opacity: 0;
      transform: scale(0.5);
      transition: all 0.15s ease;
      color: #FFFFFF;
      stroke-width: 3;
    }

    .todo-check.checked {
      background: var(--accent);
      border-color: var(--accent);
    }

    .todo-check.checked svg {
      opacity: 1;
      transform: scale(1);
    }

    .todo-text {
      flex: 1;
      font-size: 15px;
      color: var(--text);
      line-height: 1.4;
      transition: all var(--transition);
    }

    .todo-item.checked-item .todo-text,
    .todo-item.sinking .todo-text {
      text-decoration: line-through;
      color: var(--text-tertiary);
    }

    .todo-delete {
      flex-shrink: 0;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: transparent;
      color: var(--text-tertiary);
      border-radius: 6px;
      cursor: pointer;
      transition: all var(--transition);
      opacity: 0;
      padding: 0;
    }

    .todo-item:hover .todo-delete {
      opacity: 1;
    }

    @media (max-width: 640px) {
      .todo-delete {
        opacity: 0.5;
      }
    }

    .todo-delete:hover {
      color: var(--accent);
      background: var(--accent-light);
    }

    .todo-delete svg {
      width: 15px;
      height: 15px;
      stroke-width: 2;
    }

    /* Checked section label */
    .todo-checked-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-tertiary);
      padding: 20px 0 8px;
    }

    /* Empty state */
    .todo-empty {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-tertiary);
      font-size: 14px;
    }

    /* Mobile FAB for adding tasks */
    .todo-fab {
      display: none;
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: var(--accent);
      color: #FFFFFF;
      border: none;
      box-shadow: 0 4px 16px rgba(232, 104, 74, 0.35);
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 850;
      transition: transform 0.2s ease;
    }

    .todo-fab:active {
      transform: scale(0.9);
    }

    .todo-fab svg {
      width: 24px;
      height: 24px;
      stroke-width: 2.5;
    }

    @media (max-width: 640px) {
      .todo-fab.visible {
        display: flex;
      }
    }

    /* Add task overlay */
    .todo-input-overlay {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 20px 24px;
      padding-bottom: max(20px, env(safe-area-inset-bottom));
      z-index: 1000;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.08);
    }

    .todo-input-overlay.open {
      transform: translateY(0);
    }

    .todo-input-row {
      display: flex;
      gap: 10px;
    }

    .todo-input-field {
      flex: 1;
      padding: 12px 16px;
      border: 1.5px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 15px;
      font-family: inherit;
      color: var(--text);
      background: var(--bg);
      outline: none;
      transition: border-color var(--transition);
    }

    .todo-input-field:focus {
      border-color: var(--accent);
    }

    .todo-input-ok {
      padding: 12px 20px;
      background: var(--accent);
      color: #FFFFFF;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: background var(--transition);
    }

    .todo-input-ok:hover {
      background: var(--accent-hover);
    }

    /* ========================================
       PROGRESS — VIDEO LINKS (minimalist)
       ======================================== */
    .progress-videos-toggle {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      margin-top: 8px;
      padding: 0;
      font-size: 12px;
      font-weight: 500;
      color: var(--accent);
      background: none;
      border: none;
      cursor: pointer;
      font-family: inherit;
      opacity: 0.8;
      transition: opacity var(--transition);
    }

    .progress-videos-toggle:hover {
      opacity: 1;
    }

    .progress-videos-toggle svg {
      width: 14px;
      height: 14px;
      stroke-width: 2;
    }

    .progress-video-list {
      margin-top: 8px;
      padding-left: 4px;
    }

    .progress-video-link {
      display: block;
      padding: 5px 0;
      font-size: 13px;
      color: var(--text-secondary);
      text-decoration: none;
      transition: color var(--transition);
      line-height: 1.4;
      border-bottom: 1px solid var(--border);
    }

    .progress-video-link:last-child {
      border-bottom: none;
    }

    .progress-video-link:hover {
      color: var(--accent);
    }

    .progress-video-loading {
      font-size: 12px;
      color: var(--text-tertiary);
      padding: 6px 0;
    }

    /* ========================================
       TOAST NOTIFICATION
       ======================================== */
    .toast {
      position: fixed;
      bottom: 32px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--text);
      color: #FFFFFF;
      padding: 12px 24px;
      border-radius: 100px;
      font-size: 14px;
      font-weight: 500;
      font-family: inherit;
      box-shadow: var(--shadow-lg);
      z-index: 3000;
      opacity: 0;
      transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      white-space: nowrap;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* ========================================
       POMODORO TIMER — FAB BUTTON
       ======================================== */
    .timer-fab {
      position: relative;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--accent);
      border: 4px solid var(--surface);
      box-shadow: 0 4px 16px rgba(232, 104, 74, 0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin-top: -28px;
      z-index: 10;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .timer-fab:hover {
      transform: scale(1.08);
      box-shadow: 0 6px 20px rgba(232, 104, 74, 0.45);
    }

    .timer-fab:active {
      transform: scale(0.95);
    }

    .timer-fab svg {
      width: 24px;
      height: 24px;
      color: #FFFFFF;
      stroke-width: 2;
    }

    /* Desktop timer button */
    .desktop-timer-btn {
      position: fixed;
      top: 20px;
      right: 24px;
      z-index: 800;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 18px;
      font-size: 13px;
      font-weight: 500;
      font-family: inherit;
      color: #FFFFFF;
      background: var(--accent);
      border: none;
      border-radius: 100px;
      cursor: pointer;
      transition: all var(--transition);
    }

    .desktop-timer-btn:hover {
      background: var(--accent-hover);
      box-shadow: 0 4px 14px rgba(232, 104, 74, 0.3);
    }

    .desktop-timer-btn svg {
      width: 16px;
      height: 16px;
      stroke-width: 2;
    }

    @media (max-width: 640px) {
      .desktop-timer-btn {
        display: none;
      }
    }

    /* ========================================
       POMODORO TIMER — FULLSCREEN OVERLAY
       ======================================== */
    .timer-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2500;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .timer-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    /* Expanding circle background */
    .timer-bg-circle {
      position: absolute;
      border-radius: 50%;
      background: var(--accent);
      transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      transform: scale(0);
      width: 200vmax;
      height: 200vmax;
      top: 50%;
      left: 50%;
      margin-top: -100vmax;
      margin-left: -100vmax;
    }

    .timer-overlay.active .timer-bg-circle {
      transform: scale(1);
    }

    /* Timer content */
    .timer-content {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 32px;
      color: #FFFFFF;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.4s ease 0.3s;
    }

    .timer-overlay.active .timer-content {
      opacity: 1;
      transform: translateY(0);
    }

    .timer-close {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 2;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.15);
      border: none;
      color: #FFFFFF;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s;
      opacity: 0;
      transition: all 0.3s ease 0.5s;
    }

    .timer-overlay.active .timer-close {
      opacity: 1;
    }

    .timer-close:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    .timer-title {
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      opacity: 0.8;
    }

    /* ========================================
       POMODORO — TIME PICKER
       ======================================== */
    .timer-picker {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .timer-picker-btn {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.1);
      color: #FFFFFF;
      font-size: 1.5rem;
      font-weight: 300;
      font-family: inherit;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.15s ease;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .timer-picker-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.5);
    }

    .timer-picker-btn:active {
      transform: scale(0.9);
      background: rgba(255, 255, 255, 0.3);
    }

    .timer-picker-display {
      font-size: 4rem;
      font-weight: 200;
      letter-spacing: -0.02em;
      min-width: 140px;
      text-align: center;
      line-height: 1;
      font-variant-numeric: tabular-nums;
    }

    .timer-picker-label {
      font-size: 13px;
      opacity: 0.6;
      text-align: center;
      margin-top: -8px;
    }

    .timer-start-btn {
      padding: 14px 48px;
      border-radius: 100px;
      background: #FFFFFF;
      color: var(--accent);
      font-size: 16px;
      font-weight: 700;
      font-family: inherit;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      letter-spacing: 0.04em;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    .timer-start-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.2);
    }

    .timer-start-btn:active {
      transform: scale(0.97);
    }

    /* ========================================
       POMODORO — COUNTDOWN STATE
       ======================================== */
    .timer-countdown {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 24px;
    }

    .timer-countdown.active {
      display: flex;
    }

    .timer-ring-wrap {
      position: relative;
      width: 240px;
      height: 240px;
    }

    .timer-ring-wrap svg {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
    }

    .timer-ring-bg {
      fill: none;
      stroke: rgba(255, 255, 255, 0.15);
      stroke-width: 4;
    }

    .timer-ring-progress {
      fill: none;
      stroke: #FFFFFF;
      stroke-width: 4;
      stroke-linecap: round;
      transition: stroke-dashoffset 1s linear;
    }

    .timer-ring-time {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 3.5rem;
      font-weight: 200;
      color: #FFFFFF;
      font-variant-numeric: tabular-nums;
      letter-spacing: -0.01em;
    }

    .timer-ring-label {
      font-size: 13px;
      opacity: 0.7;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .timer-pause-btn {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.4);
      background: rgba(255, 255, 255, 0.1);
      color: #FFFFFF;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .timer-pause-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .timer-pause-btn:active {
      transform: scale(0.9);
    }

    .timer-pause-btn svg {
      width: 24px;
      height: 24px;
      stroke-width: 2;
    }

    /* ========================================
       POMODORO — TIMEOUT STATE
       ======================================== */
    .timer-overlay.timeout .timer-bg-circle {
      background: radial-gradient(circle at center, #FF3B30 0%, #CC2D25 40%, #991F1A 80%, #661510 100%);
    }

    .timer-timeout-msg {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      animation: timeoutPulse 2s ease infinite;
    }

    .timer-timeout-msg.active {
      display: flex;
    }

    .timer-timeout-msg h2 {
      font-size: 2rem;
      font-weight: 700;
      color: #FFFFFF;
      letter-spacing: -0.02em;
    }

    .timer-timeout-msg p {
      font-size: 15px;
      color: rgba(255, 255, 255, 0.8);
    }

    .timer-dismiss-btn {
      margin-top: 12px;
      padding: 12px 36px;
      border-radius: 100px;
      background: rgba(255, 255, 255, 0.2);
      color: #FFFFFF;
      border: 1.5px solid rgba(255, 255, 255, 0.4);
      font-size: 15px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }

    .timer-dismiss-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    @keyframes timeoutPulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.85;
      }
    }

    /* Hide picker/countdown when toggling states */
    .timer-setup {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 32px;
    }

    .timer-setup.hidden {
      display: none;
    }

    /* ========================================
       MOBILE BOTTOM NAV
       ======================================== */
    .mobile-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 8px 0;
      padding-bottom: max(8px, env(safe-area-inset-bottom));
      z-index: 900;
    }

    .mobile-nav-inner {
      display: flex;
      justify-content: space-around;
      max-width: 300px;
      margin: 0 auto;
    }

    .mobile-nav-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      padding: 6px 16px;
      font-size: 11px;
      font-weight: 500;
      font-family: inherit;
      color: var(--text-tertiary);
      background: transparent;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all var(--transition);
    }

    .mobile-nav-btn.active {
      color: var(--accent);
    }

    .mobile-nav-btn svg {
      width: 22px;
      height: 22px;
      stroke-width: 1.8;
    }

    /* ========================================
       RESPONSIVE
       ======================================== */
    @media (max-width: 640px) {
      .header {
        padding: 32px 0 20px;
      }

      .header h1 {
        font-size: 1.6rem;
      }

      .nav-tabs {
        display: none;
      }

      .mobile-nav {
        display: flex;
      }

      .input-form {
        padding: 24px;
        margin-bottom: 32px;
      }

      #schedule-container {
        grid-template-columns: 1fr;
        gap: 12px;
        padding-bottom: 100px;
      }

      .day-card {
        padding: 20px;
      }

      #lightbox-content {
        padding: 24px;
        margin: 12px;
      }

      .progress-view {
        padding-bottom: 120px;
      }

      .toast {
        bottom: 90px;
      }

      .footer {
        padding-bottom: 80px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- MODE TOGGLE -->
    <button class="mode-toggle-desktop" id="mode-toggle-desktop" onclick="toggleAppMode()">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path d="M9 11l3 3L22 4" />
        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" />
      </svg>
      To Do
    </button>

    <!-- ===== SCHEDULER VIEW ===== -->
    <div class="app-view" id="scheduler-view">
      <!-- HEADER -->
      <header class="header">
        <h1>AI Learning <span>Scheduler</span></h1>
        <p>Generate a personalized study plan, powered by AI</p>
      </header>

      <!-- MOBILE MODE TOGGLE (below header) -->
      <div style="text-align:center">
        <button class="mode-toggle-mobile" id="mode-toggle-mobile" onclick="toggleAppMode()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M9 11l3 3L22 4" />
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" />
          </svg>
          To Do
        </button>
      </div>

      <!-- NAV TABS (desktop) -->
      <nav class="nav-tabs" id="desktop-nav">
        <button class="nav-tab active" data-tab="schedule" onclick="switchTab('schedule')">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
            <line x1="16" y1="2" x2="16" y2="6" />
            <line x1="8" y1="2" x2="8" y2="6" />
            <line x1="3" y1="10" x2="21" y2="10" />
          </svg>
          Schedule
        </button>
        <button class="nav-tab" data-tab="progress" onclick="switchTab('progress')">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
          </svg>
          Progress
        </button>
      </nav>
      <button class="desktop-timer-btn" onclick="openTimer()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="12" cy="12" r="10" />
          <polyline points="12 6 12 12 16 14" />
        </svg>
        Pomodoro
      </button>

      <!-- ===== SCHEDULE TAB ===== -->
      <div class="tab-content active" id="tab-schedule">

        <!-- ACTION BAR -->
        <div class="action-bar">
          <button id="import-btn" class="btn-ghost">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="17 8 12 3 7 8" />
              <line x1="12" y1="3" x2="12" y2="15" />
            </svg>
            Import
          </button>
          <input type="file" id="file-input" accept=".xml" style="display:none;">
          <button id="export-btn" class="btn-ghost">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="7 10 12 15 17 10" />
              <line x1="12" y1="15" x2="12" y2="3" />
            </svg>
            Download
          </button>
        </div>

        <!-- FORM -->
        <form id="schedule-form" class="input-form">
          <div class="input-group">
            <label for="topic">What do you want to learn?</label>
            <input type="text" id="topic" name="topic" placeholder="e.g., Python, Machine Learning, Guitar…" required>
          </div>

          <div class="input-group">
            <label for="duration-value">How much time to finish?</label>
            <div class="duration-input-container">
              <input type="number" id="duration-value" name="duration-value" placeholder="e.g., 7" min="1" required>
              <select id="duration-unit" name="duration-unit">
                <option value="days" selected>Days</option>
                <option value="weeks">Weeks</option>
                <option value="months">Months</option>
                <option value="years">Years</option>
              </select>
            </div>
          </div>

          <div class="input-group">
            <label for="commitment">How many hours per day?</label>
            <input type="text" id="commitment" name="commitment" placeholder="e.g., 2 hours" required>
          </div>

          <button type="submit" class="btn-primary">Generate Schedule</button>
        </form>

        <!-- LOADING -->
        <div id="loading">
          <div class="loader-content">
            <div class="loader">
              <span></span>
              <span></span>
              <span></span>
            </div>
            <p>Generating your plan…</p>
          </div>
        </div>

        <!-- SAVE ROUTINE BUTTON -->
        <div class="save-routine-bar" id="save-routine-bar">
          <button class="btn-save-routine" onclick="saveRoutine()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z" />
            </svg>
            Mark as my routine
          </button>
        </div>

        <!-- SCHEDULE GRID -->
        <div id="schedule-container"></div>

      </div><!-- /tab-schedule -->

      <!-- ===== PROGRESS TAB ===== -->
      <div class="tab-content" id="tab-progress">
        <div class="progress-view" id="progress-view"></div>
      </div>

      <!-- FOOTER -->
      <footer class="footer" id="app-footer">
        AI Learning Scheduler &middot; Powered by Gemini
      </footer>
    </div><!-- /scheduler-view -->

    <!-- ===== TO-DO VIEW ===== -->
    <div class="todo-wrapper" id="todo-wrapper">
      <div class="todo-header">
        <h2>To Do</h2>
        <button class="todo-add-btn-desktop" onclick="openTodoInput()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <line x1="12" y1="5" x2="12" y2="19" />
            <line x1="5" y1="12" x2="19" y2="12" />
          </svg>
          Add Task
        </button>
      </div>
      <div id="todo-list"></div>
    </div>

    <!-- MOBILE BOTTOM NAV -->
    <nav class="mobile-nav" id="mobile-nav">
      <div class="mobile-nav-inner">
        <button class="mobile-nav-btn active" data-tab="schedule" onclick="switchTab('schedule')">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
            <line x1="16" y1="2" x2="16" y2="6" />
            <line x1="8" y1="2" x2="8" y2="6" />
            <line x1="3" y1="10" x2="21" y2="10" />
          </svg>
          Schedule
        </button>
        <button class="timer-fab" onclick="openTimer()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="12" cy="12" r="10" />
            <polyline points="12 6 12 12 16 14" />
          </svg>
        </button>
        <button class="mobile-nav-btn" data-tab="progress" onclick="switchTab('progress')">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
          </svg>
          Progress
        </button>
      </div>
    </nav>

    <!-- POMODORO TIMER OVERLAY -->
    <div class="timer-overlay" id="timer-overlay">
      <div class="timer-bg-circle"></div>
      <button class="timer-close" onclick="closeTimer()">&times;</button>
      <div class="timer-content">
        <!-- SETUP STATE -->
        <div class="timer-setup" id="timer-setup">
          <div class="timer-title">Pomodoro Timer</div>
          <div class="timer-picker">
            <button class="timer-picker-btn" onclick="adjustTime(-5)">&#8722;</button>
            <div>
              <div class="timer-picker-display" id="timer-display">25:00</div>
              <div class="timer-picker-label">minutes</div>
            </div>
            <button class="timer-picker-btn" onclick="adjustTime(5)">+</button>
          </div>
          <button class="timer-start-btn" onclick="startTimer()">Start Focus</button>
        </div>
        <!-- COUNTDOWN STATE -->
        <div class="timer-countdown" id="timer-countdown">
          <div class="timer-ring-label">Focusing</div>
          <div class="timer-ring-wrap">
            <svg viewBox="0 0 240 240">
              <circle class="timer-ring-bg" cx="120" cy="120" r="110" />
              <circle class="timer-ring-progress" id="timer-ring" cx="120" cy="120" r="110" />
            </svg>
            <div class="timer-ring-time" id="timer-ring-time">25:00</div>
          </div>
          <button class="timer-pause-btn" id="timer-pause-btn" onclick="togglePause()">
            <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
              stroke="currentColor">
              <rect x="6" y="4" width="4" height="16" />
              <rect x="14" y="4" width="4" height="16" />
            </svg>
            <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              style="display:none">
              <polygon points="5 3 19 12 5 21 5 3" />
            </svg>
          </button>
        </div>
        <!-- TIMEOUT STATE -->
        <div class="timer-timeout-msg" id="timer-timeout">
          <h2>Time's Up!</h2>
          <p>Great focus session. Take a break.</p>
          <button class="timer-dismiss-btn" onclick="closeTimer()">Done</button>
        </div>
      </div>
    </div>

    <!-- TOAST -->
    <div class="toast" id="toast"></div>

    <!-- TO-DO FAB (mobile) -->
    <button class="todo-fab" id="todo-fab" onclick="openTodoInput()">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <line x1="12" y1="5" x2="12" y2="19" />
        <line x1="5" y1="12" x2="19" y2="12" />
      </svg>
    </button>

    <!-- TO-DO INPUT OVERLAY -->
    <div class="todo-input-overlay" id="todo-input-overlay">
      <div class="todo-input-row">
        <input type="text" class="todo-input-field" id="todo-input-field" placeholder="What needs to be done?"
          maxlength="200">
        <button class="todo-input-ok" onclick="addTodoFromInput()">OK</button>
      </div>
    </div>

  </div><!-- /container -->

  <!-- LIGHTBOX MODAL -->
  <div id="lightbox-overlay">
    <div id="lightbox-content">
      <span class="close-btn">&times;</span>
      <div id="lightbox-body"></div>
    </div>
  </div>

  <script>
    // --- 1. DOM Element Caching ---
    const form = document.getElementById('schedule-form');
    const container = document.getElementById('schedule-container');
    const loadingIndicator = document.getElementById('loading');
    const lightboxOverlay = document.getElementById('lightbox-overlay');
    const lightboxBody = document.getElementById('lightbox-body');
    const closeBtn = document.querySelector('.close-btn');
    const importBtn = document.getElementById('import-btn');
    const exportBtn = document.getElementById('export-btn');
    const fileInput = document.getElementById('file-input');

    let scheduleDataCache = null;

    async function handleScheduleGeneration(event) {
      event.preventDefault();
      loadingIndicator.style.display = 'flex';
      container.innerHTML = '';
      scheduleDataCache = [];

      let isFirstCard = true;
      let cardIndex = 0;

      const durationValue = document.getElementById('duration-value').value;
      const durationUnit = document.getElementById('duration-unit').value;

      const formData = {
        topic: document.getElementById('topic').value,
        total_duration: `${durationValue} ${durationUnit}`,
        daily_commitment: document.getElementById('commitment').value
      };
      try {
        const response = await fetch('/generate-schedule', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        if (!response.ok) {
          throw new Error(`Network response was not ok (${response.status})`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });

          while (buffer.includes('\n')) {
            const newlineIndex = buffer.indexOf('\n');
            const line = buffer.substring(0, newlineIndex).trim();
            buffer = buffer.substring(newlineIndex + 1);

            if (line) {
              try {
                const dayData = JSON.parse(line);

                if (dayData.error) {
                  throw new Error(dayData.error);
                }
                if (isFirstCard) {
                  loadingIndicator.style.display = 'none';
                  isFirstCard = false;
                }

                scheduleDataCache.push(dayData);
                appendDayCard(dayData, scheduleDataCache.length - 1, cardIndex);
                cardIndex++;

              } catch (e) {
                console.error('Failed to parse JSON line:', line, e);
              }
            }
          }
        }

      } catch (error) {
        container.innerHTML = `<p class="error-message">Could not generate schedule. ${error.message}</p>`;
        console.error('Fetch error:', error);
      } finally {
        loadingIndicator.style.display = 'none';
        if (scheduleDataCache && scheduleDataCache.length > 0) {
          document.getElementById('save-routine-bar').classList.add('visible');
        }
      }
    }

    // --- 3. UI Helper Functions ---

    function appendDayCard(day, index, cardIndex) {
      const exerciseSummary = day.exercise.length > 100 ? day.exercise.substring(0, 100) + '…' : day.exercise;

      const periodText = String(day.day).toLowerCase().includes('month')
        ? day.day
        : `Day ${day.day}`;

      const card = document.createElement('div');
      card.className = 'day-card';
      card.style.animationDelay = `${(cardIndex || 0) * 0.06}s`;
      card.onclick = () => openLightbox(index);
      card.innerHTML = `
        <div class="day-label">${periodText}</div>
        <h2>${day.topic_of_the_day}</h2>
        <h3>Tasks</h3>
        <ul>${day.tasks.slice(0, 2).map(task => `<li>${task}</li>`).join('')} ${day.tasks.length > 2 ? '<li>…</li>' : ''}</ul>
        <span class="exercise-label">Exercise</span>
        <p>${exerciseSummary}</p>
      `;
      container.appendChild(card);
    }

    function displaySchedule(scheduleData) {
      if (!scheduleData || scheduleData.length === 0) {
        container.innerHTML = '';
        return;
      }

      container.innerHTML = '';
      scheduleData.forEach((day, index) => {
        appendDayCard(day, index, index);
      });
    }

    // --- 4. Lightbox (Modal) Logic ---

    function openLightbox(index) {
      if (!scheduleDataCache || !scheduleDataCache[index]) return;

      document.body.classList.add('no-scroll');
      const day = scheduleDataCache[index];

      const periodText = String(day.day).toLowerCase().includes('month')
        ? day.day
        : `Day ${day.day}`;

      let lightboxHTML = `
        <span class="lightbox-day-label">${periodText}</span>
        <h2>${day.topic_of_the_day}</h2>
        <h3>Tasks</h3>
        <ul>${day.tasks.map(task => `<li>${task}</li>`).join('')}</ul>
        <strong>Exercise</strong>
        <p>${day.exercise}</p>
        
        <div class="video-section">
            <h3>Recommended Videos</h3>
            <div id="video-container">
                <div class="skeleton-grid">
                    ${Array(4).fill(0).map(() => `
                        <div class="skeleton-card">
                            <div class="skeleton-thumb"></div>
                            <div class="skeleton-info">
                                <div class="skeleton-text"></div>
                                <div class="skeleton-text short"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
      `;

      lightboxBody.innerHTML = lightboxHTML;
      lightboxOverlay.style.display = 'flex';

      // Fetch videos
      const dayTopic = day.topic_of_the_day;
      const mainTopic = document.getElementById('topic').value.trim();
      const combinedQuery = mainTopic ? `${mainTopic} ${dayTopic}` : dayTopic;

      fetch(`/get-videos?topic=${encodeURIComponent(combinedQuery)}`)
        .then(response => {
          if (!response.ok) throw new Error('Failed to load videos');
          return response.json();
        })
        .then(videos => {
          const videoContainer = document.getElementById('video-container');
          if (videos.length === 0) {
            videoContainer.innerHTML = '<p>No videos found.</p>';
            return;
          }

          const videoHTML = `
                <div class="video-grid">
                    ${videos.map(video => `
                        <a href="https://www.youtube.com/watch?v=${video.videoId}" target="_blank" class="video-card">
                            <img src="${video.thumbnail}" alt="${video.title}">
                            <div class="video-info">
                                <div class="video-title" title="${video.title}">${video.title}</div>
                                <div class="channel-title">${video.channelTitle}</div>
                            </div>
                        </a>
                    `).join('')}
                </div>
            `;
          videoContainer.innerHTML = videoHTML;
        })
        .catch(error => {
          console.error(error);
          const videoContainer = document.getElementById('video-container');
          videoContainer.innerHTML = '<p style="color:var(--text-tertiary); font-size: 13px;">Could not load videos.</p>';
        });
    }

    function closeLightbox() {
      document.body.classList.remove('no-scroll');
      lightboxOverlay.style.display = 'none';
    }

    // --- 5. Import / Export Logic ---

    function exportToXML() {
      if (!scheduleDataCache || scheduleDataCache.length === 0) {
        alert('Please generate a schedule first.');
        return;
      }

      const escapeXML = (str) => String(str).replace(/[<>&'"]/g, c =>
        ({ '<': '&lt;', '>': '&gt;', '&': '&amp;', '\'': '&apos;', '"': '&quot;' }[c])
      );

      let xmlString = '<?xml version="1.0" encoding="UTF-8"?>\n<schedule>\n';

      scheduleDataCache.forEach(day => {
        xmlString += `  <day id="${day.day}">\n`;
        xmlString += `    <topic>${escapeXML(day.topic_of_the_day)}</topic>\n`;
        xmlString += `    <tasks>\n`;
        day.tasks.forEach(task => { xmlString += `      <task>${escapeXML(task)}</task>\n`; });
        xmlString += `    </tasks>\n`;
        xmlString += `    <exercise>${escapeXML(day.exercise)}</exercise>\n`;
        xmlString += `  </day>\n`;
      });

      xmlString += '</schedule>';

      const blob = new Blob([xmlString], { type: 'application/xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'schedule.xml';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function handleFileImport(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(e.target.result, "application/xml");

          if (xmlDoc.getElementsByTagName("parsererror").length) {
            throw new Error("Failed to parse XML. File may be corrupt.");
          }

          const importedData = [];
          const dayNodes = xmlDoc.getElementsByTagName("day");

          for (const dayNode of dayNodes) {
            const dayData = {
              day: dayNode.getAttribute("id"),
              topic_of_the_day: dayNode.querySelector("topic").textContent,
              tasks: Array.from(dayNode.querySelectorAll("tasks task")).map(task => task.textContent),
              exercise: dayNode.querySelector("exercise").textContent
            };
            importedData.push(dayData);
          }

          scheduleDataCache = importedData;
          displaySchedule(scheduleDataCache);

        } catch (error) {
          showToast('Invalid schedule file');
          console.error("XML Import Error:", error);
        }
      };

      reader.readAsText(file);
      fileInput.value = '';
    }

    // --- 6. Event Listeners ---

    form.addEventListener('submit', handleScheduleGeneration);

    closeBtn.addEventListener('click', closeLightbox);
    lightboxOverlay.addEventListener('click', (event) => {
      if (event.target === lightboxOverlay) closeLightbox();
    });
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') closeLightbox();
    });

    importBtn.addEventListener('click', () => fileInput.click());
    exportBtn.addEventListener('click', exportToXML);
    fileInput.addEventListener('change', handleFileImport);

    // --- 7. Tab Navigation ---

    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.getElementById('tab-' + tabName).classList.add('active');

      document.querySelectorAll('.nav-tab').forEach(el => {
        el.classList.toggle('active', el.dataset.tab === tabName);
      });
      document.querySelectorAll('.mobile-nav-btn').forEach(el => {
        el.classList.toggle('active', el.dataset.tab === tabName);
      });

      if (tabName === 'progress') renderRoutines();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // --- 8. Toast ---

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2500);
    }

    // --- 9. Routine Storage ---

    const STORAGE_KEY = 'ai_scheduler_routines';

    function getRoutines() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
      catch { return []; }
    }

    function setRoutines(routines) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(routines));
    }

    function saveRoutine() {
      if (!scheduleDataCache || scheduleDataCache.length === 0) {
        showToast('Generate a schedule first');
        return;
      }
      const topic = document.getElementById('topic').value.trim() || 'Untitled';
      const routines = getRoutines();
      const routine = {
        id: Date.now().toString(),
        topic: topic,
        savedAt: new Date().toISOString(),
        schedule: scheduleDataCache,
        progress: {}
      };
      scheduleDataCache.forEach((day, i) => {
        routine.progress[i] = {
          tasks: new Array(day.tasks.length).fill(false),
          exercise: false
        };
      });
      routines.unshift(routine);
      setRoutines(routines);
      document.getElementById('save-routine-bar').classList.remove('visible');
      showToast('Routine saved!');
      setTimeout(() => switchTab('progress'), 400);
    }

    let pendingDeleteId = null;

    function deleteRoutine(id) {
      if (pendingDeleteId === id) {
        // Second click = confirmed
        const routines = getRoutines().filter(r => r.id !== id);
        setRoutines(routines);
        renderRoutines();
        showToast('Routine deleted');
        pendingDeleteId = null;
      } else {
        // First click = ask to confirm via toast
        pendingDeleteId = id;
        showToast('Tap delete again to confirm');
        setTimeout(() => { pendingDeleteId = null; }, 3000);
      }
    }

    function getRoutineProgress(routine) {
      let total = 0, done = 0;
      for (const key in routine.progress) {
        const p = routine.progress[key];
        total += p.tasks.length + 1;
        done += p.tasks.filter(Boolean).length + (p.exercise ? 1 : 0);
      }
      return total > 0 ? Math.round((done / total) * 100) : 0;
    }

    // --- 10. Render Progress Tab ---

    const CIRC = 2 * Math.PI * 16;

    function renderRoutines() {
      const view = document.getElementById('progress-view');
      const routines = getRoutines();

      if (routines.length === 0) {
        view.innerHTML = '<div class="empty-state">' +
          '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>' +
          '<h3>No routines yet</h3>' +
          '<p>Generate a schedule and tap "Mark as my routine" to start tracking</p></div>';
        return;
      }

      let html = '';
      routines.forEach((routine, rIdx) => {
        const pct = getRoutineProgress(routine);
        const offset = CIRC - (pct / 100) * CIRC;
        const date = new Date(routine.savedAt);
        const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const daysCount = routine.schedule.length;

        let daysHTML = '';
        routine.schedule.forEach((day, dIdx) => {
          const periodText = String(day.day).toLowerCase().includes('month') ? day.day : 'Day ' + day.day;
          const prog = routine.progress[dIdx] || { tasks: [], exercise: false };

          let tasksHTML = '';
          day.tasks.forEach((task, tIdx) => {
            const chk = prog.tasks[tIdx] ? 'checked' : '';
            tasksHTML += '<label class="check-item">' +
              '<input type="checkbox" ' + chk + ' onchange="toggleCheck(\'' + routine.id + '\',' + dIdx + ',\'task\',' + tIdx + ')">' +
              '<span class="check-box"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="20 6 9 17 4 12"/></svg></span>' +
              '<span class="check-label">' + task + '</span></label>';
          });

          const exChk = prog.exercise ? 'checked' : '';
          const exHTML = '<label class="check-item">' +
            '<input type="checkbox" ' + exChk + ' onchange="toggleCheck(\'' + routine.id + '\',' + dIdx + ',\'exercise\',0)">' +
            '<span class="check-box"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="20 6 9 17 4 12"/></svg></span>' +
            '<span class="check-label exercise-check">' + day.exercise + '</span></label>';

          daysHTML += '<div class="progress-day">' +
            '<div class="progress-day-header">' + periodText + '</div>' +
            '<div class="progress-day-topic">' + day.topic_of_the_day + '</div>' +
            tasksHTML + exHTML +
            '<button class="progress-videos-toggle" onclick="event.stopPropagation(); loadProgressVideos(this, \'' + routine.topic.replace(/'/g, '') + '\', \'' + day.topic_of_the_day.replace(/'/g, '') + '\')">' +
            '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>' +
            'Videos</button>' +
            '</div>';
        });

        html += '<div class="routine-card" id="routine-' + routine.id + '" style="animation-delay:' + (rIdx * 0.06) + 's">' +
          '<div class="routine-header" onclick="toggleRoutine(\'' + routine.id + '\')">' +
          '<div class="routine-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg></div>' +
          '<div class="routine-info">' +
          '<div class="routine-title">' + routine.topic + '</div>' +
          '<div class="routine-meta">' + daysCount + ' days \u00b7 Saved ' + dateStr + '</div>' +
          '</div>' +
          '<div class="routine-progress-ring">' +
          '<svg width="40" height="40">' +
          '<circle class="ring-bg" cx="20" cy="20" r="16" fill="none" stroke-width="3"/>' +
          '<circle class="ring-fill" cx="20" cy="20" r="16" fill="none" stroke-width="3" stroke-dasharray="' + CIRC + '" stroke-dashoffset="' + offset + '" stroke-linecap="round"/>' +
          '</svg>' +
          '<span class="routine-pct">' + pct + '%</span>' +
          '</div>' +
          '<button class="routine-delete" onclick="event.stopPropagation(); deleteRoutine(\'' + routine.id + '\')">' +
          '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>' +
          '</button>' +
          '<svg class="routine-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>' +
          '</div>' +
          '<div class="routine-body"><div class="routine-body-inner">' + daysHTML + '</div></div>' +
          '</div>';
      });

      view.innerHTML = html;
    }

    function toggleRoutine(id) {
      document.getElementById('routine-' + id).classList.toggle('expanded');
    }

    function toggleCheck(routineId, dayIdx, type, taskIdx) {
      const routines = getRoutines();
      const routine = routines.find(r => r.id === routineId);
      if (!routine) return;

      if (type === 'task') {
        routine.progress[dayIdx].tasks[taskIdx] = !routine.progress[dayIdx].tasks[taskIdx];
      } else {
        routine.progress[dayIdx].exercise = !routine.progress[dayIdx].exercise;
      }
      setRoutines(routines);

      // Optimistic progress ring update
      const pct = getRoutineProgress(routine);
      const offset = CIRC - (pct / 100) * CIRC;
      const card = document.getElementById('routine-' + routineId);
      if (card) {
        const ring = card.querySelector('.ring-fill');
        const pctLabel = card.querySelector('.routine-pct');
        if (ring) ring.setAttribute('stroke-dashoffset', offset);
        if (pctLabel) pctLabel.textContent = pct + '%';
      }
    }

    // Initialize progress tab
    renderRoutines();

    // --- 11. Progress Video Links ---

    function loadProgressVideos(btn, mainTopic, dayTopic) {
      const parent = btn.parentElement;
      // Toggle off if already loaded
      const existing = parent.querySelector('.progress-video-list');
      if (existing) {
        existing.remove();
        return;
      }

      const container = document.createElement('div');
      container.className = 'progress-video-list';
      container.innerHTML = '<div class="progress-video-loading">Loading...</div>';
      parent.appendChild(container);

      const query = mainTopic + ' ' + dayTopic;
      fetch('/get-videos?topic=' + encodeURIComponent(query))
        .then(r => r.json())
        .then(videos => {
          if (!videos || videos.length === 0) {
            container.innerHTML = '<div class="progress-video-loading">No videos found</div>';
            return;
          }
          container.innerHTML = videos.map(v =>
            '<a class="progress-video-link" href="https://www.youtube.com/watch?v=' + v.videoId + '" target="_blank">' + v.title + '</a>'
          ).join('');
        })
        .catch(() => {
          container.innerHTML = '<div class="progress-video-loading">Could not load videos</div>';
        });
    }

    // --- 11. Pomodoro Timer ---

    let pomodoroMinutes = 25;
    let pomodoroSeconds = 0;
    let pomodoroInterval = null;
    let pomodoroTotalSeconds = 25 * 60;
    let pomodoroPaused = false;
    const RING_CIRCUMFERENCE = 2 * Math.PI * 110;

    function formatTime(min, sec) {
      return String(min).padStart(2, '0') + ':' + String(sec).padStart(2, '0');
    }

    function openTimer() {
      const overlay = document.getElementById('timer-overlay');
      overlay.classList.remove('timeout');
      resetTimerUI();
      overlay.classList.add('active');
      document.body.classList.add('no-scroll');
    }

    function closeTimer() {
      const overlay = document.getElementById('timer-overlay');
      if (pomodoroInterval) {
        clearInterval(pomodoroInterval);
        pomodoroInterval = null;
      }
      overlay.classList.remove('active', 'timeout');
      document.body.classList.remove('no-scroll');
      pomodoroPaused = false;
      pomodoroMinutes = 25;
      pomodoroSeconds = 0;
    }

    function resetTimerUI() {
      document.getElementById('timer-setup').classList.remove('hidden');
      document.getElementById('timer-countdown').classList.remove('active');
      document.getElementById('timer-timeout').classList.remove('active');
      document.getElementById('timer-display').textContent = formatTime(pomodoroMinutes, 0);
      document.getElementById('pause-icon').style.display = '';
      document.getElementById('play-icon').style.display = 'none';
      pomodoroPaused = false;
      if (pomodoroInterval) {
        clearInterval(pomodoroInterval);
        pomodoroInterval = null;
      }
    }

    function adjustTime(delta) {
      pomodoroMinutes = Math.max(5, Math.min(120, pomodoroMinutes + delta));
      const display = document.getElementById('timer-display');
      display.textContent = formatTime(pomodoroMinutes, 0);
      // Tactile scale pop
      display.style.transform = 'scale(1.08)';
      setTimeout(() => { display.style.transform = 'scale(1)'; }, 120);
    }

    function startTimer() {
      pomodoroTotalSeconds = pomodoroMinutes * 60;
      pomodoroSeconds = pomodoroTotalSeconds;
      pomodoroPaused = false;

      // Switch to countdown view
      document.getElementById('timer-setup').classList.add('hidden');
      document.getElementById('timer-countdown').classList.add('active');

      // Init ring
      const ring = document.getElementById('timer-ring');
      ring.style.strokeDasharray = RING_CIRCUMFERENCE;
      ring.style.strokeDashoffset = '0';

      updateTimerDisplay();

      pomodoroInterval = setInterval(() => {
        if (pomodoroPaused) return;
        pomodoroSeconds--;

        if (pomodoroSeconds <= 0) {
          clearInterval(pomodoroInterval);
          pomodoroInterval = null;
          onTimeout();
          return;
        }

        updateTimerDisplay();

        // Update ring
        const progress = 1 - (pomodoroSeconds / pomodoroTotalSeconds);
        const offset = progress * RING_CIRCUMFERENCE;
        ring.style.strokeDashoffset = -offset;
      }, 1000);
    }

    function updateTimerDisplay() {
      const min = Math.floor(pomodoroSeconds / 60);
      const sec = pomodoroSeconds % 60;
      document.getElementById('timer-ring-time').textContent = formatTime(min, sec);
    }

    function togglePause() {
      pomodoroPaused = !pomodoroPaused;
      document.getElementById('pause-icon').style.display = pomodoroPaused ? 'none' : '';
      document.getElementById('play-icon').style.display = pomodoroPaused ? '' : 'none';
    }

    function onTimeout() {
      const overlay = document.getElementById('timer-overlay');
      overlay.classList.add('timeout');
      document.getElementById('timer-countdown').classList.remove('active');
      document.getElementById('timer-timeout').classList.add('active');
    }

    // --- 12. To-Do Feature ---

    let todoMode = localStorage.getItem('ai_scheduler_mode') === 'todo';

    function getTodos() {
      try { return JSON.parse(localStorage.getItem('ai_scheduler_todos')) || []; }
      catch { return []; }
    }

    function setTodos(todos) {
      localStorage.setItem('ai_scheduler_todos', JSON.stringify(todos));
    }

    function toggleAppMode() {
      todoMode = !todoMode;
      localStorage.setItem('ai_scheduler_mode', todoMode ? 'todo' : 'scheduler');
      applyAppMode(true);
    }

    function applyAppMode(animate) {
      const schedulerView = document.getElementById('scheduler-view');
      const todoWrapper = document.getElementById('todo-wrapper');
      const mobileNav = document.getElementById('mobile-nav');
      const todoFab = document.getElementById('todo-fab');
      const desktopTimerBtn = document.querySelector('.desktop-timer-btn');
      const footer = document.getElementById('app-footer');
      const toggleDesktop = document.getElementById('mode-toggle-desktop');
      const toggleMobile = document.getElementById('mode-toggle-mobile');

      // SVG icons
      const checkIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>';
      const calendarIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>';

      if (todoMode) {
        toggleDesktop.innerHTML = calendarIcon + ' AI Scheduler';
        toggleMobile.innerHTML = calendarIcon + ' AI Scheduler';
        if (animate) {
          schedulerView.classList.add('vanish');
          setTimeout(() => {
            schedulerView.style.display = 'none';
            todoWrapper.classList.add('active');
            mobileNav.style.display = 'none';
            if (todoFab) todoFab.classList.add('visible');
            if (desktopTimerBtn) desktopTimerBtn.style.display = 'none';
            if (footer) footer.style.display = 'none';
            renderTodoList();
          }, 350);
        } else {
          schedulerView.style.display = 'none';
          schedulerView.classList.add('vanish');
          todoWrapper.classList.add('active');
          mobileNav.style.display = 'none';
          if (todoFab) todoFab.classList.add('visible');
          if (desktopTimerBtn) desktopTimerBtn.style.display = 'none';
          if (footer) footer.style.display = 'none';
          renderTodoList();
        }
      } else {
        toggleDesktop.innerHTML = checkIcon + ' To Do';
        toggleMobile.innerHTML = checkIcon + ' To Do';
        todoWrapper.classList.remove('active');
        if (todoFab) todoFab.classList.remove('visible');
        closeTodoInput();
        if (animate) {
          setTimeout(() => {
            schedulerView.style.display = '';
            schedulerView.classList.remove('vanish');
            mobileNav.style.display = '';
            if (desktopTimerBtn) desktopTimerBtn.style.display = '';
            if (footer) footer.style.display = '';
          }, 50);
        } else {
          schedulerView.style.display = '';
          schedulerView.classList.remove('vanish');
          mobileNav.style.display = '';
          if (desktopTimerBtn) desktopTimerBtn.style.display = '';
          if (footer) footer.style.display = '';
        }
      }
    }

    function renderTodoList() {
      const list = document.getElementById('todo-list');
      const todos = getTodos();

      if (todos.length === 0) {
        list.innerHTML = '<div class="todo-empty">No tasks yet. Tap + to add one.</div>';
        return;
      }

      const unchecked = todos.filter(t => !t.done);
      const checked = todos.filter(t => t.done);

      let html = '';
      unchecked.forEach((t, i) => {
        const idx = todos.indexOf(t);
        html += buildTodoItem(t, idx, i);
      });

      if (checked.length > 0) {
        html += '<div class="todo-checked-label">Completed</div>';
        checked.forEach((t, i) => {
          const idx = todos.indexOf(t);
          html += buildTodoItem(t, idx, unchecked.length + i);
        });
      }

      list.innerHTML = html;
    }

    function buildTodoItem(t, idx, animIdx) {
      const checkedClass = t.done ? 'checked-item' : '';
      const checkClass = t.done ? 'checked' : '';
      return '<div class="todo-item ' + checkedClass + '" style="animation-delay:' + (animIdx * 0.04) + 's">' +
        '<button class="todo-check ' + checkClass + '" onclick="toggleTodo(' + idx + ')">' +
        '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="20 6 9 17 4 12"/></svg>' +
        '</button>' +
        '<span class="todo-text">' + t.text + '</span>' +
        '<button class="todo-delete" onclick="deleteTodo(' + idx + ')">' +
        '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>' +
        '</button>' +
        '</div>';
    }

    function toggleTodo(idx) {
      const todos = getTodos();
      if (!todos[idx]) return;
      todos[idx].done = !todos[idx].done;
      setTodos(todos);

      if (todos[idx].done) {
        // Show checked state immediately, then move to Completed after 5s
        renderTodoList();
        setTimeout(() => renderTodoList(), 5000);
      } else {
        renderTodoList();
      }
    }

    function deleteTodo(idx) {
      const todos = getTodos();
      todos.splice(idx, 1);
      setTodos(todos);
      renderTodoList();
    }

    function openTodoInput() {
      const overlay = document.getElementById('todo-input-overlay');
      const field = document.getElementById('todo-input-field');
      overlay.classList.add('open');
      setTimeout(() => field.focus(), 300);
    }

    function closeTodoInput() {
      const overlay = document.getElementById('todo-input-overlay');
      overlay.classList.remove('open');
      document.getElementById('todo-input-field').value = '';
    }

    function addTodoFromInput() {
      const field = document.getElementById('todo-input-field');
      const text = field.value.trim();
      if (!text) return;

      const todos = getTodos();
      todos.push({ text: text, done: false, id: Date.now() });
      setTodos(todos);
      field.value = '';
      closeTodoInput();
      renderTodoList();
    }

    // Enter key to submit
    document.getElementById('todo-input-field').addEventListener('keydown', function (e) {
      if (e.key === 'Enter') addTodoFromInput();
    });

    // Initialize mode on load
    if (todoMode) {
      applyAppMode(false);
    }

  </script>
</body>

</html>